<!DOCTYPE html>
<html lang="en">
<head>

        <!-- Use correct character set. -->
        <meta charset="utf-8">
        <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
        <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
        <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
        <title>#Berlin3D - Greenhouse Gas Emission Estimator</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="Build/Cesium/Widgets/widgets.css" media="screen">
        <script  src="Build/Cesium/Cesium.js"></script>

        <style>
        html {
                height: 100%;
        }

        body {
                height: 100%;
                width: 100%;
                margin: 0;
                overflow: hidden;
                padding: 0;
                background: #000;
        }

        .fullWindow {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                margin: 0;
                overflow: hidden;
                padding: 0;
                font-family: sans-serif;
        }

        .loadingIndicator {
                display: block;
                position: absolute;
                top: 50%;
                left: 50%;
                margin-top: -33px;
                margin-left: -33px;
                width: 66px;
                height: 66px;
                background-position: center;
                background-repeat: no-repeat;
                background-image: url(Images/ajax-loader.gif);
        }

        </style>

</head>
<body style="background: #000;">
        <div id="cesiumContainer" class="fullWindow"></div>
        <div id="loadingIndicator" class="loadingIndicator"></div>
</body>
<script>
document.ontouchmove = function(e) {e.preventDefault()};

//var extent = Cesium.Rectangle.fromDegrees(13.0475307, 52.3910277, 13.0648685, 52.3998398);
var extent = Cesium.Rectangle.fromDegrees(13.3190346, 52.5065701, 13.3363724, 52.515359);
var globalJson = "http://localhost:8080/static/co2/co2.json";
var defaultTransparency = 0.75;
var wfsURL = "http://localhost:8080/citydb-wfs/wfs";

Cesium.Camera.DEFAULT_VIEW_FACTOR=0;
Cesium.Camera.DEFAULT_VIEW_RECTANGLE = extent;

Cesium.DataSourceDisplay.defaultVisualizersCallback = function (scene, dataSource) {
        var entities = dataSource.entities;
        return [
                new Cesium.ModelVisualizer(scene, entities)
        ];
};
var viewer;
try {
        viewer = new Cesium.Viewer('cesiumContainer', {
                imageryProvider : new Cesium.OpenStreetMapImageryProvider({
                        url : 'http://tile.openstreetmap.de/tiles/osmde',
                        credit: '©OpenStreetMap contributors'
                }),
                "timeline":false,
                "animation":false,
                "baseLayerPicker":false,
                "geocoder":false,
                "infoBox":true,
                "sceneModePicker":false,
                "selectionIndicator":true,
                "navigationHelpButton":true,
                "navigationInstructionsInitiallyVisible":true,
                "scene3DOnly":true

        });
} catch (exception) {
        document.getElementById("loadingIndicator").style.display = 'none';
        console.error(exception);
        if (!document.querySelector('.cesium-widget-errorPanel')) {
                window.alert(exception);
        }
}

var canvas =  viewer.scene.canvas;
var scene = viewer.scene;
var dataSources = {};

var getTileStructure = function(){
        var tilesToRender = scene.globe._surface._tilesToRender;
        var tiles = [];
        for(var i = 0; i < tilesToRender.length; i++){
                if(tilesToRender[i].level >= maxLevel){
                        var tile = {
                                bbox:[tilesToRender[i].rectangle.west,
                                tilesToRender[i].rectangle.south,
                                tilesToRender[i].rectangle.east,
                                tilesToRender[i].rectangle.north],
                                level:tilesToRender[i]._level,
                                distance:tilesToRender[i]._distance
                        }
                        tiles.push(tile);
                }
        }
        return tiles;
}
var worker = new Worker('TilesWorkerTiled.js');

worker.addEventListener('message', function(e) {
        var data = e.data;
        switch (data.cmd) {
                case 'add':
                var id =  data.data.id;
                var url = data.data.url;
                var x = data.data.x;
                var y = data.data.y;
                var z = data.data.z;
                var modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(
                        Cesium.Cartesian3.fromDegrees(x, y, 0.0));
                        dataSources[id] = scene.primitives.add(Cesium.Model.fromGltf({
                                url : url,
                                modelMatrix : modelMatrix,
                                scale : 1,
                                allowPicking:true
                        })
                );
                break;
                case 'remove':
                var ids =  data.ids;
                var counter = 0;
                for(var i = 0; i < ids.length; i++){
                        var id = ids[i];
                        if(dataSources.hasOwnProperty(id)){
                                scene.primitives.remove(dataSources[id]);
                                delete dataSources[id];
                                counter++
                        }
                }
                break;
        }
}, false);

worker.postMessage({'cmd':'initialize', 'url':globalJson});

viewer.scene.postRender.addEventListener(function(scene, time)  {
        worker.postMessage({'cmd':'postRender'});
});

var camera = viewer.camera;
var removeEnd = camera.moveEnd.addEventListener(function() {
        console.log("cameraListenerEnd");
        worker.postMessage({'cmd':'tileStructureChanged', "tiles":getTileStructure(), "maxLevel":maxLevel, "maxModels":maxModels});
});

var showLoadError = function(name, error) {
        var title = 'An error occurred while loading the file: ' + name;
        var message = 'An error occurred while loading the file, which may indicate that it is invalid.  A detailed error report is below:';
        viewer.cesiumWidget.showErrorPanel(title, message, error);
};

// add copyright information for berlin model
viewer.scene.frameState.creditDisplay.addDefaultCredit(new Cesium.Credit('GFZ', 'http://www.gfz-potsdam.de/fileadmin/templates/images/svg/GFZ_Logo_SVG_klein_de.svg', 'http://www.gfz-potsdam.de'));
viewer.scene.frameState.creditDisplay.addDefaultCredit(new Cesium.Credit('LoCaL', 'http://www.climate-kic.org/wp-content/themes/climatekic/img/printlogo.gif', 'http://www.climate-kic.org/programmes/low-carbon-city-lab'));
viewer.scene.frameState.creditDisplay.addDefaultCredit(new Cesium.Credit('Made with data from Berlin Partner and Immobilienscout24.'));

function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

var maxLevel = parseInt(getParameterByName("maxLevel"));
var maxModels = parseInt(getParameterByName("maxModels"));

if(isNaN(maxLevel)){
        maxLevel = 16;
}
console.log("Set MaxLevel to " + maxLevel);
if(isNaN(maxModels)){
        maxModels = 500;
}
console.log("Set MaxModels to " + maxModels);

loadingIndicator.style.display = 'none';

// Enable picking of buildings.
var oldMat;
var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
handler.setInputAction(
        function (movement) {
                var object = scene.pick(movement.position);
                if (Cesium.defined(object) && Cesium.defined(object.node)) {

                        if (oldMat != null) {
                                oldMat.setValue('transparency', defaultTransparency);
                        }

                        var materials = object.primitive.gltf.materials;
                        var matID = "";
                        for (var key in materials) {
                                matID = materials[key].name;
                        }

                        var mat = object.primitive.getMaterial(matID);
                        mat.setValue('transparency', 1);

                        var cacheKey = object.primitive.cacheKey;
                        var splitted = cacheKey.split("/");
                        splitted = splitted[splitted.length - 1];
                        var id = splitted.split(".")[0];
                        requestWFS(id);
                        oldMat = mat;
                }
        },
        Cesium.ScreenSpaceEventType.LEFT_CLICK
);

/** Request attribute data from WFS. */
function requestWFS(id) {
        var XHR = new XMLHttpRequest();
        var urlEncodedData = "";
        var urlEncodedDataPairs = [];
        var name;

        XHR.addEventListener('load', function(event) {
                var responseXML = XHR.responseXML;
                nsResolver = document.createNSResolver(responseXML.documentElement);

                var energyAttributes = getEnergyAttributesAsHTML(responseXML, nsResolver);
                // Cesium InfoBox
                var entity = new Cesium.Entity();
                entity.description = {
                        getValue : function() {
                                return energyAttributes;
                        }
                };
                viewer.selectedEntity = entity;
        });
        XHR.addEventListener('error', function(event) {
                alert('Oups! Something goes wrong.');
        });
        XHR.open('POST', wfsURL);
        XHR.setRequestHeader('Content-Type', 'text/xml');
        var wfsQuery = buildWFSquery(id);
        XHR.send(wfsQuery);
}

/** Generates getFeature request with given id. */
function buildWFSquery(id) {
        return "<?xml version=\"1.0\" encoding=\"UTF-8\"?> <wfs:GetFeature service=\"WFS\" version=\"2.0.0\" xmlns:wfs=\"http://www.opengis.net/wfs/2.0\"> <wfs:StoredQuery id=\"http://www.opengis.net/def/query/OGC-WFS/0/GetFeatureById\"> <wfs:Parameter name=\"id\">" + id + "</wfs:Parameter> </wfs:StoredQuery> </wfs:GetFeature>";
}

/** Get energy relevant attributes as html table. */
function getEnergyAttributesAsHTML(xmlDoc, nsResolver) {
        var energyAttributes = getEnergyAttributes(xmlDoc, nsResolver);
        var table = "<table style=\"width:100%\">";
        table += "<thead> <tr> <th>Attribute</th> <th>Value</th> </tr> </thead>";
        table += "<tbody>";
        for (var key in energyAttributes) {
                table += "<tr>";
                table += "<td>" + key + "</td>";
                table += "<td>" + energyAttributes[key] + "</td>";
                table += "</tr>";
        }
        table += "</tbody>";
        table += "</table>";
        return table;
}

/** Returns energy relevant attributes from given xmlDoc. */
function getEnergyAttributes(xmlDoc, nsResolver) {
        var energy_rating_type  = xmlDoc.evaluate('string(/bldg:Building/gen:stringAttribute[@name=\'energy_rating_type\']/gen:value)', xmlDoc, nsResolver, XPathResult.ANY_TYPE, null).stringValue;
        var heating_type  = xmlDoc.evaluate('string(/bldg:Building/gen:stringAttribute[@name=\'heating_type\']/gen:value)', xmlDoc, nsResolver, XPathResult.ANY_TYPE, null).stringValue;
        var heating_type_enev_2014  = xmlDoc.evaluate('string(/bldg:Building/gen:stringAttribute[@name=\'heating_type_enev2014\']/gen:value)', xmlDoc, nsResolver, XPathResult.ANY_TYPE, null).stringValue;
        var energy_source_enev_2014  = xmlDoc.evaluate('string(/bldg:Building/gen:stringAttribute[@name=\'energy_source_enev2014\']/gen:value)', xmlDoc, nsResolver, XPathResult.ANY_TYPE, null).stringValue;
        var thermal_characteristic  = xmlDoc.evaluate('string(/bldg:Building/gen:doubleAttribute[@name=\'thermal_characteristic\']/gen:value)', xmlDoc, nsResolver, XPathResult.ANY_TYPE, null).stringValue;
        var energy_consumption_contains_warm_water  = xmlDoc.evaluate('string(/bldg:Building/gen:stringAttribute[@name=\'energy_consumption_contains_warm_water\']/gen:value)', xmlDoc, nsResolver, XPathResult.ANY_TYPE, null).stringValue;
        var co2_emissions = xmlDoc.evaluate('string(/bldg:Building/gen:doubleAttribute[@name=\'co2_emissions\']/gen:value)', xmlDoc, nsResolver, XPathResult.ANY_TYPE, null).stringValue;
        var co2 = parseFloat(co2_emissions);
        // CO2 emissions are in g CO2/(a m^2), thus tranform them to kg.
        co2 = co2 / 1000;
        co2 = Math.round(co2 * 100) / 100;

        var attr = new Object();
        attr['Energy Rating Type: '] = energy_rating_type;
        attr['Heating Type: '] = heating_type;
        attr['Heating Type Enev2014: '] = heating_type_enev_2014;
        attr['Energy Source Enev2014: '] = energy_source_enev_2014;
        attr['Thermal Characteristic: '] = thermal_characteristic + " kWh/(a m²)";
        attr['CO2 Emissions: '] = co2 + " kg CO2/(a m²)";
        attr['Energy Consumption Contains Warm Water: '] = energy_consumption_contains_warm_water;
        return attr;
}

</script>
</html>
